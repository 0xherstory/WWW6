<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torvalds Market Desk - Table View</title>
    <style>
        :root {
            --bg: #0a0a0a;
            --surface: #141414;
            --surface-hover: #1f1f1f;
            --border: #333;
            --text-main: #e6e6e6;
            --text-muted: #888;
            --accent: #00ff9d;
            --market-blue: #2d9cdb;
            --danger: #ff4444;
            --warning: #ffa500;
        }

        * { box-sizing: border-box; }

        body {
            background: var(--bg);
            color: var(--text-main);
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        .layout-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            height: 100vh;
        }

        /* å·¦ä¾§å¸‚åœºè¡¨æ ¼åŒºåŸŸ */
        .market-section {
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            overflow: hidden;
        }

        /* å¤´éƒ¨å·¥å…·æ  */
        .market-header {
            padding: 1rem 1.5rem;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .header-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .live-indicator {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* è¯­è¨€é€‰æ‹©å™¨ */
        .language-selector {
            display: flex;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }

        .lang-btn {
            padding: 0.4rem 0.8rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .lang-btn.active {
            background: var(--accent);
            color: #000;
        }

        .lang-btn:hover:not(.active) {
            color: var(--text-main);
        }

        /* ç­›é€‰å™¨ */
        .filter-section {
            padding: 1rem 1.5rem;
            background: #0f0f0f;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            color: var(--text-main);
            font-size: 0.9rem;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--accent);
        }

        .filter-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-tag {
            padding: 0.3rem 0.8rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .filter-tag:hover {
            border-color: var(--accent);
        }

        .filter-tag.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        .view-toggle {
            display: flex;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }

        .view-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: var(--accent);
            color: #000;
        }

        /* è¡¨æ ¼å®¹å™¨ */
        .table-container {
            flex: 1;
            overflow: auto;
            background: var(--bg);
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: var(--bg);
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* å¸‚åœºè¡¨æ ¼ */
        .market-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .market-table th {
            background: var(--surface);
            padding: 0.8rem 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .market-table th.sortable {
            cursor: pointer;
            user-select: none;
        }

        .market-table th.sortable:hover {
            color: var(--accent);
        }

        .market-table td {
            padding: 1rem;
            border-bottom: 1px solid #1a1a1a;
            vertical-align: middle;
        }

        .market-table tr {
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .market-table tr:hover {
            background: var(--surface-hover);
        }

        .market-table tr.selected {
            background: rgba(0, 255, 157, 0.1);
            border-left: 3px solid var(--accent);
        }

        /* å¸‚åœºæ ‡é¢˜åˆ— */
        .market-title-cell {
            max-width: 300px;
        }

        .market-title {
            font-weight: 500;
            color: var(--text-main);
            line-height: 1.4;
            margin-bottom: 0.3rem;
        }

        .market-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .market-tag {
            background: rgba(45, 156, 219, 0.2);
            color: var(--market-blue);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* æ•°å€¼åˆ— */
        .number-cell {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            text-align: right;
        }

        .volume-cell {
            color: var(--accent);
            font-weight: 600;
        }

        .price-cell {
            color: var(--market-blue);
        }

        .probability-cell {
            font-weight: 600;
        }

        .probability-high {
            color: #4ade80;
        }

        .probability-medium {
            color: var(--warning);
        }

        .probability-low {
            color: var(--danger);
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-active {
            background: var(--accent);
        }

        .status-ending {
            background: var(--warning);
        }

        .status-closed {
            background: var(--danger);
        }

        /* å³ä¾§åˆ†æé¢æ¿ */
        .agent-sidebar {
            background: #000;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border);
            height: 100vh;
        }

        .agent-header {
            padding: 1rem;
            background: #0f0f0f;
            border-bottom: 1px solid var(--border);
            font-size: 0.8rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            box-shadow: 0 0 5px var(--accent);
        }

        .agent-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            gap: 1rem;
            overflow: hidden;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .config-input {
            background: #111;
            border: 1px solid #333;
            color: var(--accent);
            padding: 0.8rem;
            font-family: monospace;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        .agent-input {
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 1rem;
            min-height: 120px;
            font-family: inherit;
            resize: none;
            line-height: 1.5;
            border-radius: 4px;
        }

        .agent-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-exec {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 1rem;
            font-weight: 800;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: opacity 0.2s;
            border-radius: 4px;
        }

        .btn-exec:hover {
            opacity: 0.9;
        }

        .btn-exec:disabled {
            background: #444;
            cursor: not-allowed;
        }

        #log-area {
            flex: 1;
            background: #080808;
            border: 1px solid #222;
            border-left: 3px solid var(--accent);
            padding: 1rem;
            overflow-y: auto;
            font-size: 0.8rem;
            white-space: pre-wrap;
            line-height: 1.6;
            margin-top: 1rem;
            border-radius: 4px;
        }

        .step-header {
            color: var(--accent);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px dashed #333;
            padding-bottom: 5px;
            font-weight: bold;
        }

        .error {
            color: var(--danger);
        }

        .success {
            color: #55ff55;
            font-weight: bold;
        }

        .info {
            color: var(--text-muted);
            font-style: italic;
        }

        /* åˆ†é¡µå™¨ */
        .pagination {
            padding: 1rem 1.5rem;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .pagination-info {
            color: var(--text-muted);
        }

        .pagination-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .pagination-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 0.3rem 0.6rem;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .pagination-btn:hover:not(:disabled) {
            border-color: var(--accent);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-size-select {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>

<div class="layout-container">
    
    <!-- å·¦ä¾§ï¼šå¸‚åœºæ•°æ®è¡¨æ ¼ -->
    <main class="market-section">
        
        <!-- å¤´éƒ¨å·¥å…·æ  -->
        <div class="market-header">
            <div class="header-title">
                <span class="live-indicator"></span>
                Market Analysis Dashboard
            </div>
            <div class="header-controls">
                <div class="language-selector">
                    <button class="lang-btn active" data-lang="zh">ä¸­æ–‡</button>
                    <button class="lang-btn" data-lang="en">English</button>
                </div>
                <div class="view-toggle">
                    <button class="view-btn active">Table</button>
                    <button class="view-btn">Visualization</button>
                </div>
            </div>
        </div>

        <!-- ç­›é€‰å™¨ -->
        <div class="filter-section">
            <input type="text" class="search-box" placeholder="Search markets..." id="searchInput">
            
            <div class="filter-tags">
                <div class="filter-tag active" data-filter="all">All</div>
                <div class="filter-tag" data-filter="politics">Politics</div>
                <div class="filter-tag" data-filter="crypto">Crypto</div>
                <div class="filter-tag" data-filter="sports">Sports</div>
                <div class="filter-tag" data-filter="tech">Tech</div>
                <div class="filter-tag" data-filter="economy">Economy</div>
                <div class="filter-tag" data-filter="entertainment">Entertainment</div>
                <div class="filter-tag" data-filter="esports">Esports</div>
                <div class="filter-tag" data-filter="social">Social</div>
                <div class="filter-tag" data-filter="business">Business</div>
                <div class="filter-tag" data-filter="ai">AI</div>
                <div class="filter-tag" data-filter="culture">Culture</div>
            </div>
        </div>

        <!-- è¡¨æ ¼å®¹å™¨ -->
        <div class="table-container">
            <table class="market-table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="title">å¸‚åœº</th>
                        <th class="sortable" data-sort="liquidity">æµåŠ¨æ€§</th>
                        <th class="sortable" data-sort="volume">äº¤æ˜“é‡</th>
                        <th class="sortable" data-sort="vol24h">24h äº¤æ˜“é‡</th>
                        <th class="sortable" data-sort="openInterest">æœªå¹³ä»“åˆçº¦</th>
                        <th class="sortable" data-sort="yesPrice">Yes ä»·æ ¼</th>
                        <th class="sortable" data-sort="yesOI">Yes O.I.</th>
                        <th class="sortable" data-sort="noPrice">No ä»·æ ¼</th>
                        <th class="sortable" data-sort="noOI">No O.I.</th>
                        <th class="sortable" data-sort="lastTrade">æœ€åäº¤æ˜“</th>
                        <th class="sortable" data-sort="bestBid">æœ€ä½³å‡ºä»·</th>
                    </tr>
                </thead>
                <tbody id="marketTableBody">
                    <!-- æ•°æ®å°†é€šè¿‡ JavaScript å¡«å…… -->
                </tbody>
            </table>
        </div>

        <!-- åˆ†é¡µå™¨ -->
        <div class="pagination">
            <div class="pagination-info">
                æ˜¾ç¤º <span id="showingStart">1</span>-<span id="showingEnd">10</span> å…± <span id="totalItems">0</span> ä¸ªå¸‚åœº
            </div>
            <div class="pagination-controls">
                <select class="page-size-select" id="pageSizeSelect">
                    <option value="10">æ¯é¡µ 10 æ¡</option>
                    <option value="25">æ¯é¡µ 25 æ¡</option>
                    <option value="50">æ¯é¡µ 50 æ¡</option>
                </select>
                <button class="pagination-btn" id="prevBtn">â€¹ ä¸Šä¸€é¡µ</button>
                <span id="pageInfo">1 / 1</span>
                <button class="pagination-btn" id="nextBtn">ä¸‹ä¸€é¡µ â€º</button>
            </div>
        </div>

    </main>

    <!-- å³ä¾§ï¼šåˆ†æé¢æ¿ -->
    <aside class="agent-sidebar">
        <div class="agent-header">
            <span>:: Torvalds Intel Agent ::</span>
            <div class="status-dot"></div>
        </div>
        
        <div class="agent-body">
            <div class="input-group">
                <input type="password" id="apiKey" class="config-input" placeholder="Enter OpenRouter API Key (sk-...)">
                <textarea id="userInput" class="agent-input" placeholder="ç‚¹å‡»å·¦ä¾§è¡¨æ ¼ä¸­çš„å¸‚åœºè¿›è¡Œåˆ†æ...

æˆ–è€…ç›´æ¥è¾“å…¥ä½ æƒ³åˆ†æçš„2026å¹´é—®é¢˜ï¼š
- Will Bitcoin reach $200,000 by end of 2026?
- Will there be a major recession in 2026?
- Will Apple release a foldable iPhone in 2026?
- Will SpaceX successfully land humans on Mars in 2026?"></textarea>
                <button id="btnStart" class="btn-exec" onclick="agent.start()">EXECUTE ANALYSIS</button>
            </div>

            <div id="log-area">SYSTEM ONLINE.
READY FOR MARKET ANALYSIS...

ğŸ“Š ä½¿ç”¨è¯´æ˜ï¼š
1. åœ¨å·¦ä¾§è¡¨æ ¼ä¸­æµè§ˆå¸‚åœºæ•°æ®
2. ä½¿ç”¨æœç´¢å’Œç­›é€‰åŠŸèƒ½æ‰¾åˆ°æ„Ÿå…´è¶£çš„å¸‚åœº
3. ç‚¹å‡»ä»»æ„è¡Œé€‰æ‹©å¸‚åœºè¿›è¡Œåˆ†æ
4. è¾“å…¥ OpenRouter API Key å¼€å§‹åˆ†æ</div>
        </div>
    </aside>

</div>

<script>
/**
 * 2026å¹´æ¨¡æ‹Ÿå¸‚åœºæ•°æ® - åŸºäºå‚è€ƒå›¾ç‰‡ï¼Œä½¿ç”¨ Polymarket æ ‡å‡†åˆ†ç±»
 */
const MOCK_MARKETS = [
    {
        id: 615000,
        title: "Will Simers be nominated for outstanding performance by a cast in a motion picture at the 52nd actor awards?",
        category: "entertainment",
        liquidity: 678,
        volume: 900,
        vol24h: 52,
        openInterest: 951,
        yesPrice: 0.94,
        yesOI: 94.00,
        noPrice: 0.06,
        noOI: 6.00,
        lastTrade: 94.00,
        bestBid: null,
        endDate: "2026/1/7 08:00:00",
        status: "active"
    },
    {
        id: 1370193,
        title: "Will mONEY finish in the top 5 of the MLTY Top 20 Players of 2025?",
        category: "esports",
        liquidity: 1132,
        volume: 1029,
        vol24h: 213,
        openInterest: 998,
        yesPrice: 0.9446,
        yesOI: 94.46,
        noPrice: 0.0554,
        noOI: 5.54,
        lastTrade: 94.46,
        bestBid: null,
        endDate: "2026/1/10 08:00:00",
        status: "active"
    },
    {
        id: 615014,
        title: "Will Wagner Moura be nominated for Best Actor at the 98th Academy Awards?",
        category: "entertainment",
        liquidity: 59572,
        volume: 8442,
        vol24h: 4148,
        openInterest: 99976,
        yesPrice: 0.922,
        yesOI: 92.20,
        noPrice: 0.078,
        noOI: 7.80,
        lastTrade: 92.20,
        bestBid: null,
        endDate: "2026/1/22 08:00:00",
        status: "active"
    },
    {
        id: 603330,
        title: "Will MrBeast hit 106.5 billion views by March 31?",
        category: "social",
        liquidity: 941,
        volume: 2293,
        vol24h: 0,
        openInterest: 964,
        yesPrice: 0.9985,
        yesOI: 99.85,
        noPrice: 0.0015,
        noOI: 0.15,
        lastTrade: 99.85,
        bestBid: null,
        endDate: "2026/3/31 08:00:00",
        status: "active"
    },
    {
        id: 734858,
        title: "Will Donald Trump visit New Jersey in 2026?",
        category: "politics",
        liquidity: 329,
        volume: 1402,
        vol24h: 0,
        openInterest: 97,
        yesPrice: 0.935,
        yesOI: 93.50,
        noPrice: 0.065,
        noOI: 6.50,
        lastTrade: 93.50,
        bestBid: null,
        endDate: "2026/12/31 08:00:00",
        status: "active"
    },
    {
        id: 1087073,
        title: "Will any AI model reach a Chatbot Arena score of at least 1500 by December 31?",
        category: "ai",
        liquidity: 4541,
        volume: 10814,
        vol24h: 849,
        openInterest: 960,
        yesPrice: 0.95,
        yesOI: 95.00,
        noPrice: 0.05,
        noOI: 5.00,
        lastTrade: 95.00,
        bestBid: null,
        endDate: "2026/12/31 08:00:00",
        status: "active"
    },
    {
        id: 892341,
        title: "Will Bitcoin reach $200,000 by end of 2026?",
        category: "crypto",
        liquidity: 12500,
        volume: 45000,
        vol24h: 2800,
        openInterest: 15600,
        yesPrice: 0.42,
        yesOI: 42.00,
        noPrice: 0.58,
        noOI: 58.00,
        lastTrade: 42.00,
        bestBid: 41.50,
        endDate: "2026/12/31 08:00:00",
        status: "active"
    },
    {
        id: 923847,
        title: "Will there be a major recession in 2026?",
        category: "economy",
        liquidity: 8900,
        volume: 23400,
        vol24h: 1200,
        openInterest: 8500,
        yesPrice: 0.25,
        yesOI: 25.00,
        noPrice: 0.75,
        noOI: 75.00,
        lastTrade: 25.00,
        bestBid: 24.80,
        endDate: "2026/12/31 08:00:00",
        status: "active"
    },
    {
        id: 834729,
        title: "Will Apple release a foldable iPhone in 2026?",
        category: "tech",
        liquidity: 3200,
        volume: 8900,
        vol24h: 450,
        openInterest: 4200,
        yesPrice: 0.18,
        yesOI: 18.00,
        noPrice: 0.82,
        noOI: 82.00,
        lastTrade: 18.00,
        bestBid: 17.50,
        endDate: "2026/12/31 08:00:00",
        status: "active"
    },
    {
        id: 745892,
        title: "Will SpaceX successfully land humans on Mars in 2026?",
        category: "tech",
        liquidity: 15600,
        volume: 67800,
        vol24h: 3400,
        openInterest: 23400,
        yesPrice: 0.08,
        yesOI: 8.00,
        noPrice: 0.92,
        noOI: 92.00,
        lastTrade: 8.00,
        bestBid: 7.80,
        endDate: "2026/12/31 08:00:00",
        status: "active"
    },
    {
        id: 956234,
        title: "Will Tesla stock reach $500 by end of 2026?",
        category: "business",
        liquidity: 6700,
        volume: 18900,
        vol24h: 890,
        openInterest: 7800,
        yesPrice: 0.35,
        yesOI: 35.00,
        noPrice: 0.65,
        noOI: 65.00,
        lastTrade: 35.00,
        bestBid: 34.50,
        endDate: "2026/12/31 08:00:00",
        status: "active"
    },
    {
        id: 678123,
        title: "Will the 2026 World Cup final have over 2.5 goals?",
        category: "sports",
        liquidity: 4500,
        volume: 12300,
        vol24h: 670,
        openInterest: 5600,
        yesPrice: 0.62,
        yesOI: 62.00,
        noPrice: 0.38,
        noOI: 38.00,
        lastTrade: 62.00,
        bestBid: 61.50,
        endDate: "2026/7/19 20:00:00",
        status: "active"
    },
    {
        id: 789456,
        title: "Will any celebrity couple announce engagement at the 2026 Met Gala?",
        category: "culture",
        liquidity: 2100,
        volume: 5600,
        vol24h: 320,
        openInterest: 2800,
        yesPrice: 0.28,
        yesOI: 28.00,
        noPrice: 0.72,
        noOI: 72.00,
        lastTrade: 28.00,
        bestBid: 27.50,
        endDate: "2026/5/4 23:59:00",
        status: "active"
    }
];

/**
 * å¸‚åœºæ•°æ®ç®¡ç†å™¨
 */
class MarketDataManager {
    constructor() {
        this.markets = [...MOCK_MARKETS];
        this.filteredMarkets = [...this.markets];
        this.currentPage = 1;
        this.pageSize = 10;
        this.sortField = 'volume';
        this.sortDirection = 'desc';
        this.activeFilter = 'all';
        this.searchQuery = '';
        this.selectedMarket = null;
        this.currentLanguage = 'zh'; // é»˜è®¤ä¸­æ–‡

        this.initializeEventListeners();
        this.render();
    }

    initializeEventListeners() {
        // æœç´¢
        document.getElementById('searchInput').addEventListener('input', (e) => {
            this.searchQuery = e.target.value.toLowerCase();
            this.applyFilters();
        });

        // åˆ†ç±»ç­›é€‰
        document.querySelectorAll('.filter-tag').forEach(tag => {
            tag.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                this.activeFilter = e.target.dataset.filter;
                this.applyFilters();
            });
        });

        // æ’åº
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', (e) => {
                const field = e.target.dataset.sort;
                if (this.sortField === field) {
                    this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortField = field;
                    this.sortDirection = 'desc';
                }
                this.applySort();
            });
        });

        // åˆ†é¡µ
        document.getElementById('pageSizeSelect').addEventListener('change', (e) => {
            this.pageSize = parseInt(e.target.value);
            this.currentPage = 1;
            this.render();
        });

        document.getElementById('prevBtn').addEventListener('click', () => {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.render();
            }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            const totalPages = Math.ceil(this.filteredMarkets.length / this.pageSize);
            if (this.currentPage < totalPages) {
                this.currentPage++;
                this.render();
            }
        });
    }

    applyFilters() {
        this.filteredMarkets = this.markets.filter(market => {
            // åˆ†ç±»ç­›é€‰
            const categoryMatch = this.activeFilter === 'all' || market.category === this.activeFilter;
            
            // æœç´¢ç­›é€‰
            const searchMatch = this.searchQuery === '' || 
                market.title.toLowerCase().includes(this.searchQuery) ||
                market.description.toLowerCase().includes(this.searchQuery);

            return categoryMatch && searchMatch;
        });

        this.currentPage = 1;
        this.applySort();
    }

    applySort() {
        this.filteredMarkets.sort((a, b) => {
            let aVal = a[this.sortField];
            let bVal = b[this.sortField];

            if (typeof aVal === 'string') {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }

            if (this.sortDirection === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });

        this.render();
    }

    formatVolume(volume) {
        if (volume >= 1000000) {
            return (volume / 1000000).toFixed(1) + 'M';
        } else if (volume >= 1000) {
            return (volume / 1000).toFixed(0) + 'K';
        }
        return volume.toLocaleString();
    }

    formatPrice(price) {
        if (price === null || price === undefined) return '-';
        return '$' + price.toFixed(2);
    }

    formatPercentage(value) {
        if (value === null || value === undefined) return '-';
        return value.toFixed(2) + '%';
    }

    getCategoryName(category) {
        const categoryMap = {
            'politics': 'Politics',
            'crypto': 'Crypto',
            'sports': 'Sports',
            'tech': 'Tech',
            'economy': 'Economy',
            'entertainment': 'Entertainment',
            'esports': 'Esports',
            'social': 'Social',
            'business': 'Business',
            'ai': 'AI',
            'culture': 'Culture'
        };
        return categoryMap[category] || category.toUpperCase();
    }

    getProbabilityClass(prob) {
        if (prob >= 0.6) return 'probability-high';
        if (prob >= 0.4) return 'probability-medium';
        return 'probability-low';
    }

    getStatusClass(status) {
        switch (status) {
            case 'active': return 'status-active';
            case 'ending': return 'status-ending';
            case 'closed': return 'status-closed';
            default: return 'status-active';
        }
    }

    selectMarket(market) {
        this.selectedMarket = market;
        
        // æ›´æ–° UI é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.market-table tr').forEach(row => {
            row.classList.remove('selected');
        });
        document.querySelector(`tr[data-market-id="${market.id}"]`).classList.add('selected');

        // å¡«å……åˆ†æè¾“å…¥æ¡†
        const input = document.getElementById('userInput');
        input.value = `ã€2026å¹´å¸‚åœºåˆ†æç›®æ ‡ã€‘
ID: ${market.id}
æ ‡é¢˜: "${market.title}"
åˆ†ç±»: ${this.getCategoryName(market.category)}
æµåŠ¨æ€§: ${this.formatVolume(market.liquidity)}
äº¤æ˜“é‡: ${this.formatVolume(market.volume)}
24häº¤æ˜“é‡: ${this.formatVolume(market.vol24h)}
Yesä»·æ ¼: ${this.formatPrice(market.yesPrice)}
Noä»·æ ¼: ${this.formatPrice(market.noPrice)}
ç»“æŸæ—¶é—´: ${market.endDate}

åˆ†æè¯·æ±‚:
1. åŸºäºå½“å‰å¸‚åœºæ•°æ®ï¼Œè¿™ä¸ªé¢„æµ‹çš„å‡†ç¡®æ€§å¦‚ä½•ï¼Ÿ
2. Yesä»·æ ¼ ${this.formatPercentage(market.yesOI)} æ˜¯å¦åˆç†ï¼Ÿ
3. æœ‰å“ªäº›å…³é”®å› ç´ å¯èƒ½å½±å“ç»“æœï¼Ÿ
4. æœ€è¿‘æœ‰ä»€ä¹ˆæ–°å‘å±•å¯èƒ½æ”¹å˜è¿™ä¸ªé¢„æµ‹ï¼Ÿ
5. ä¸»è¦é£é™©å’Œå‚¬åŒ–å‰‚æ˜¯ä»€ä¹ˆï¼Ÿ`;

        input.focus();
    }

    render() {
        const tbody = document.getElementById('marketTableBody');
        const startIndex = (this.currentPage - 1) * this.pageSize;
        const endIndex = startIndex + this.pageSize;
        const pageMarkets = this.filteredMarkets.slice(startIndex, endIndex);

        tbody.innerHTML = '';

        pageMarkets.forEach(market => {
            const row = document.createElement('tr');
            row.dataset.marketId = market.id;
            row.addEventListener('click', () => this.selectMarket(market));

            row.innerHTML = `
                <td class="market-title-cell">
                    <div class="market-title">${market.title}</div>
                    <div class="market-subtitle">
                        <span class="market-tag">${this.getCategoryName(market.category)}</span>
                        <span>ID: ${market.id}</span>
                    </div>
                </td>
                <td class="number-cell">${this.formatVolume(market.liquidity)}</td>
                <td class="number-cell volume-cell">${this.formatVolume(market.volume)}</td>
                <td class="number-cell">${this.formatVolume(market.vol24h)}</td>
                <td class="number-cell">${this.formatVolume(market.openInterest)}</td>
                <td class="number-cell price-cell">${this.formatPrice(market.yesPrice)}</td>
                <td class="number-cell ${this.getProbabilityClass(market.yesOI / 100)}">${this.formatPercentage(market.yesOI)}</td>
                <td class="number-cell price-cell">${this.formatPrice(market.noPrice)}</td>
                <td class="number-cell ${this.getProbabilityClass(market.noOI / 100)}">${this.formatPercentage(market.noOI)}</td>
                <td class="number-cell">${this.formatPercentage(market.lastTrade)}</td>
                <td class="number-cell">${market.bestBid ? this.formatPercentage(market.bestBid) : '-'}</td>
            `;

            tbody.appendChild(row);
        });

        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        const totalItems = this.filteredMarkets.length;
        const totalPages = Math.ceil(totalItems / this.pageSize);
        
        document.getElementById('showingStart').textContent = totalItems > 0 ? startIndex + 1 : 0;
        document.getElementById('showingEnd').textContent = Math.min(endIndex, totalItems);
        document.getElementById('totalItems').textContent = totalItems;
        document.getElementById('pageInfo').textContent = `${this.currentPage} / ${totalPages}`;
        
        document.getElementById('prevBtn').disabled = this.currentPage <= 1;
        document.getElementById('nextBtn').disabled = this.currentPage >= totalPages;
    }
}

/**
 * ç ”ç©¶ä»£ç†ï¼ˆå¤ç”¨ä¹‹å‰çš„ä»£ç ï¼‰
 */
const CONFIG = {
    MODELS: { 
        BRAIN: 'google/gemini-2.0-flash-001', 
        SEARCH: 'perplexity/sonar' 
    },
    MAX_LOOP: 2
};

const PROMPTS = {
    STEP_1: (input) => `
    [SYSTEM: MARKET_ANALYST]
    [DATE: ${new Date().toLocaleDateString('zh-CN')}] (å½“å‰æ—¶é—´ï¼š2026å¹´)
    
    INPUT: "${input}"
    
    Task: åˆ›å»ºä¸€ä¸ªç ”ç©¶æ¡†æ¶æ¥åˆ†æè¿™ä¸ª2026å¹´çš„å¸‚åœºé—®é¢˜ã€‚
    
    Output a structured analysis plan with:
    1. Key factors that will determine the outcome
    2. Data sources to check (polls, statistics, news, etc.)
    3. Timeline of important dates/events
    4. Potential biases in current market pricing
    
    Keep it concise and actionable.
    `,
    
    STEP_2: (fw) => `
    Based on this framework:
    ${fw}
    
    Generate 3-4 specific search queries to gather evidence.
    Include queries that might contradict the current consensus.
    
    Format each query as: <query>search terms here</query>
    `,
    
    STEP_3: (query) => `
    Search Query: ${query}
    
    Find factual information and cite sources.
    Distinguish between verified data and opinions.
    Focus on recent, credible sources.
    `,
    
    STEP_4: (results, fw) => `
    Framework: ${fw}
    
    Search Results: ${results}
    
    Analysis: Do we have sufficient evidence to make an informed assessment?
    
    If YES (enough data found): output <sufficient>
    If NO (need more specific data): output <insufficient> and specify what's missing
    `,
    
    STEP_5: (history) => `
    Based on all gathered evidence:
    ${history}
    
    ç”¨ä¸­æ–‡å±•ç¤ºè¾“å‡ºåˆ†æç»“æœ

    Provide a final analysis in this format:
    
    ## Market Analysis Summary
    
    **Current Consensus**: [What the market currently believes]
    
    **Key Evidence**:
    - Supporting factors: [Evidence that supports current pricing]
    - Contradicting factors: [Evidence that challenges current pricing]
    
    **Critical Dates**: [Upcoming events that could change the outcome]
    
    **Assessment**: [Your probability estimate with reasoning]
    
    **Risk Factors**: [What could make this analysis wrong]
    `
};

class ResearchAgent {
    constructor() {
        this.logEl = document.getElementById('log-area');
        this.history = [];
        this.round = 0;
        this.isRunning = false;
    }

    log(msg, type = '') {
        const div = document.createElement('div');
        if(type === 'header') div.className = 'step-header';
        else if(type === 'error') div.className = 'error';
        else if(type === 'success') div.className = 'success';
        else if(type === 'info') div.className = 'info';
        
        div.textContent = typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2);
        this.logEl.appendChild(div);
        this.logEl.scrollTop = this.logEl.scrollHeight;
    }

    async callAI(model, prompt) {
        const apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey) throw new Error("è¯·è¾“å…¥ OpenRouter API Key");
        
        this.log(`æ­£åœ¨è°ƒç”¨ ${model}...`, 'info');
        
        try {
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${apiKey}`, 
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'Torvalds Market Analyst'
                },
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.3
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                let errorMsg = `API é”™è¯¯ ${response.status}`;
                
                try {
                    const errorJson = JSON.parse(errorText);
                    errorMsg += `: ${errorJson.error?.message || errorText}`;
                } catch {
                    errorMsg += `: ${errorText}`;
                }
                
                throw new Error(errorMsg);
            }
            
            const data = await response.json();
            const content = data.choices?.[0]?.message?.content;
            
            if (!content) {
                throw new Error("API è¿”å›ç©ºå“åº”");
            }
            
            return content;
            
        } catch (error) {
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                throw new Error("ç½‘ç»œè¿æ¥å¤±è´¥ - è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– API æœåŠ¡çŠ¶æ€");
            }
            throw error;
        }
    }

    extractQueries(text) {
        return [...text.matchAll(/<query>(.*?)<\/query>/gs)].map(m => m[1].trim());
    }

    async start() {
        if(this.isRunning) return;
        
        const userInput = document.getElementById('userInput').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        
        if (!apiKey) { 
            alert("è¯·è¾“å…¥ OpenRouter API Key"); 
            return; 
        }
        if (!userInput) { 
            this.log("è¯·è¾“å…¥è¦åˆ†æçš„é—®é¢˜æˆ–é€‰æ‹©å·¦ä¾§è¡¨æ ¼ä¸­çš„å¸‚åœº", "error"); 
            return; 
        }

        this.setRunning(true);
        this.logEl.innerHTML = '';
        this.history = []; 
        this.round = 0;

        try {
            this.log(`>>> å¼€å§‹åˆ†æ...`, 'header');
            
            // STEP 1: æ„å»ºåˆ†ææ¡†æ¶
            this.log(`>>> ç¬¬1æ­¥: æ„å»ºåˆ†ææ¡†æ¶...`, 'header');
            const framework = await this.callAI(CONFIG.MODELS.BRAIN, PROMPTS.STEP_1(userInput));
            this.log(framework);
            
            await this.searchLoop(framework);

        } catch (e) {
            this.log(`åˆ†æå¤±è´¥: ${e.message}`, 'error');
            console.error('Analysis error:', e);
        } finally {
            this.setRunning(false);
        }
    }

    async searchLoop(fw) {
        this.round++;
        
        if(this.round > CONFIG.MAX_LOOP) {
            this.log("è¾¾åˆ°æœ€å¤§æœç´¢è½®æ•°ï¼Œå¼€å§‹ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š...", "info");
            return this.finalize();
        }

        this.log(`>>> ç¬¬${this.round + 1}æ­¥: ä¿¡æ¯æœç´¢ (è½®æ¬¡ ${this.round})...`, 'header');
        
        try {
            // ç”Ÿæˆæœç´¢æŸ¥è¯¢
            const qRaw = await this.callAI(CONFIG.MODELS.BRAIN, PROMPTS.STEP_2(fw));
            const queries = this.extractQueries(qRaw);
            
            if(!queries.length) {
                this.log("æœªç”Ÿæˆæœç´¢æŸ¥è¯¢ï¼Œè·³åˆ°æœ€ç»ˆåˆ†æ", "info");
                return this.finalize();
            }
            
            this.log(`ç”Ÿæˆäº† ${queries.length} ä¸ªæœç´¢æŸ¥è¯¢:`, 'info');
            queries.forEach((q, i) => this.log(`${i+1}. ${q}`, 'info'));

            // å¹¶è¡Œæ‰§è¡Œæœç´¢
            this.log("æ­£åœ¨æ‰§è¡Œå¹¶è¡Œæœç´¢...", 'info');
            const results = await Promise.all(queries.map(async (q, i) => {
                try {
                    this.log(`æœç´¢ ${i+1}/${queries.length}: ${q}`, 'info');
                    const result = await this.callAI(CONFIG.MODELS.SEARCH, PROMPTS.STEP_3(q));
                    return `æŸ¥è¯¢: ${q}\nç»“æœ: ${result}`;
                } catch (e) {
                    this.log(`æœç´¢ ${i+1} å¤±è´¥: ${e.message}`, 'error');
                    return `æŸ¥è¯¢: ${q}\né”™è¯¯: ${e.message}`;
                }
            }));
            
            const mergedResults = results.join('\n---\n');
            this.history.push(mergedResults);
            
            // è¯„ä¼°æ˜¯å¦éœ€è¦æ›´å¤šä¿¡æ¯
            this.log(">>> è¯„ä¼°æœç´¢ç»“æœ...", 'header');
            const evalRes = await this.callAI(CONFIG.MODELS.BRAIN, PROMPTS.STEP_4(this.history.join('\n'), fw));
            this.log(evalRes);
            
            if(evalRes.includes('<sufficient>')) {
                this.log("æ”¶é›†åˆ°è¶³å¤Ÿä¿¡æ¯ï¼Œç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š...", "success");
                this.finalize();
            } else {
                this.log("éœ€è¦æ›´å¤šä¿¡æ¯ï¼Œç»§ç»­æœç´¢...", "info");
                await this.searchLoop(fw);
            }
            
        } catch (e) {
            this.log(`æœç´¢è½®æ¬¡ ${this.round} å¤±è´¥: ${e.message}`, 'error');
            if (this.history.length > 0) {
                this.log("åŸºäºå·²æœ‰ä¿¡æ¯ç”ŸæˆæŠ¥å‘Š...", "info");
                this.finalize();
            } else {
                throw e;
            }
        }
    }

    async finalize() {
        this.log(`>>> ç”Ÿæˆæœ€ç»ˆåˆ†ææŠ¥å‘Š...`, 'header');
        
        try {
            const summary = await this.callAI(CONFIG.MODELS.BRAIN, PROMPTS.STEP_5(this.history.join('\n')));
            this.log("=".repeat(50));
            this.log(summary);
            this.log("=".repeat(50));
            this.log("åˆ†æå®Œæˆï¼", "success");
        } catch (e) {
            this.log(`ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šå¤±è´¥: ${e.message}`, 'error');
            this.log("åŸå§‹æœç´¢ç»“æœ:", "info");
            this.log(this.history.join('\n\n'));
        }
        
        this.setRunning(false);
    }

    setRunning(state) {
        this.isRunning = state;
        const btn = document.getElementById('btnStart');
        btn.disabled = state;
        btn.textContent = state ? "åˆ†æä¸­..." : "EXECUTE ANALYSIS";
        btn.style.opacity = state ? "0.5" : "1";
    }
}

// åˆå§‹åŒ–åº”ç”¨
const marketManager = new MarketDataManager();
const agent = new ResearchAgent();

</script>
</body>
</html>